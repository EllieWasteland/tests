<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Configuración Eduroam - UCuenca</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://i.pinimg.com/1200x/d7/2d/c3/d72dc3cee61f693fdb1793b6f6ab33c9.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: #1a1a1a;
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #parallax-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            perspective: 1000px;
        }

        .layer {
             position: absolute;
             top:0; left:0; right:0; bottom:0;
             display: flex;
             align-items: center;
             justify-content: center;
             transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .sparkle { position: absolute; width: 50px; height: 50px; color: #1a1a1a; opacity: 0; animation: fadeIn 1s ease-out 2.5s forwards; }
        .sparkle-1 { top: 15%; left: 5%; transform: rotate(15deg) scale(0.8); }
        .sparkle-2 { top: 25%; right: 10%; transform: rotate(-10deg); animation-delay: 2.7s; }
        .sparkle-3 { bottom: 20%; left: 20%; transform: rotate(25deg) scale(1.2); animation-delay: 2.9s;}

        .floating-element { position: absolute; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.5), rgba(255,255,255,0) 70%), rgba(128, 90, 213, 0.2); box-shadow: inset 0 0 20px rgba(255,255,255,0.3), 0 10px 25px rgba(0,0,0,0.1); animation: float 20s infinite ease-in-out; }
        #float1 { width: 200px; height: 200px; top: 10%; left: -5%; animation-duration: 25s;}
        #float2 { width: 150px; height: 150px; top: 70%; right: -3%; animation-duration: 30s; animation-delay: 5s;}
        #float3 { width: 80px; height: 80px; top: 80%; left: 10%; animation-duration: 18s; animation-delay: 2s;}
        #float4 { width: 120px; height: 120px; top: 5%; right: 25%; animation-duration: 22s; animation-delay: 8s;}

        .glass-pane {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            height: 90vh; max-height: 700px; width: 90vw; max-width: 480px;
            display: flex; flex-direction: column;
            opacity: 0; transform: scale(0.95);
            transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1), transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .glass-pane.visible { opacity: 1; transform: scale(1); }

        /* --- Splash Screen Mejorado --- */
        #splash-screen {
            transition: opacity 0.7s ease-out, background-color 0.5s ease, backdrop-filter 0.5s ease;
            overflow: hidden;
        }
        #splash-screen.glass-active {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* --- Animación de Partículas --- */
        #particle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* --- Keyframes --- */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 80% { opacity: 1; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes float { 0% { transform: translateY(0) translateX(0) scale(1) rotate(0deg); } 25% { transform: translateY(-30px) translateX(20px) scale(1.1) rotate(20deg); } 50% { transform: translateY(20px) translateX(-30px) scale(0.9) rotate(-10deg); } 75% { transform: translateY(-10px) translateX(40px) scale(1) rotate(15deg); } 100% { transform: translateY(0) translateX(0) scale(1) rotate(0deg); } }
        
        .animated-item { opacity: 0; }
        .current .animated-item { animation: slideInUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .current .animated-icon { animation: popIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

        #steps-container { flex: 1; position: relative; overflow: hidden; }
        .step { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .step.future { transform: translateX(100%); }
        .step.past { transform: translateX(-100%); }
        .step.current { transform: translateX(0); }
        .progress-bar-fill { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>
    <!-- Splash Screen Mejorado -->
    <div id="splash-screen" class="fixed inset-0 bg-[#F5EEFF] z-50 flex flex-col items-center justify-center text-center p-4">
        <div id="splash-content" class="transition-opacity duration-500 flex flex-col items-center justify-center w-full h-full">
            
            <!-- Estado de Detección -->
            <div id="detection-state" class="w-full h-full flex items-center justify-center relative">
                <canvas id="particle-canvas"></canvas>
                <p id="splash-text" class="text-lg text-gray-700 font-semibold animate-pulse">Detectando tu dispositivo...</p>
            </div>

            <!-- Estado de "Agitar para continuar" -->
            <div id="shake-state" class="hidden opacity-0 transition-opacity duration-700 flex-col items-center justify-center">
                <div id="os-logo-container" class="w-28 h-28 mx-auto mb-6">
                    <!-- OS Logo will be injected here -->
                </div>
                <h2 class="text-2xl font-bold text-gray-800">¡Dispositivo Detectado!</h2>
                <p class="text-lg text-gray-600 mt-2">Agita tu dispositivo para continuar</p>
                <p id="ios-permission-text" class="text-xs text-gray-500 mt-4 max-w-xs mx-auto hidden">
                    En iOS, toca la pantalla una vez para activar los sensores de movimiento.
                </p>
                <!-- Botón de fallback -->
                <button id="fallback-btn" class="hidden opacity-0 transition-all duration-500 mt-8 bg-gray-800/80 p-3 rounded-full shadow-lg hover:scale-110 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                </button>
            </div>

        </div>
    </div>
    
    <div id="parallax-scene">
        <div class="layer" data-depth="0.3"><svg class="sparkle sparkle-1" viewBox="0 0 54 54" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M27 0L32.226 21.774L54 27L32.226 32.226L27 54L21.774 32.226L0 27L21.774 21.774L27 0Z" fill="currentColor"/></svg></div>
        <div class="layer" data-depth="0.2"><svg class="sparkle sparkle-2" viewBox="0 0 54 54" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M27 0L32.226 21.774L54 27L32.226 32.226L27 54L21.774 32.226L0 27L21.774 21.774L27 0Z" fill="currentColor"/></svg></div>
        <div class="layer" data-depth="0.4"><svg class="sparkle sparkle-3" viewBox="0 0 54 54" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M27 0L32.226 21.774L54 27L32.226 32.226L27 54L21.774 32.226L0 27L21.774 21.774L27 0Z" fill="currentColor"/></svg></div>
        <div class="layer" data-depth="0.2"><div id="float1" class="floating-element"></div></div>
        <div class="layer" data-depth="0.4"><div id="float2" class="floating-element"></div></div>
        <div class="layer" data-depth="-0.2"><div id="float3" class="floating-element"></div></div>
        <div class="layer" data-depth="0.3"><div id="float4" class="floating-element"></div></div>

        <!-- Main App Container -->
        <div class="layer" data-depth="-0.1">
            <div class="glass-pane">
                <div class="relative flex flex-col h-full w-full">
                    <div class="p-4 sm:p-6 flex-shrink-0">
                        <div class="w-full bg-black/10 rounded-full h-2"><div id="progress-bar" class="bg-gray-900 h-2 rounded-full progress-bar-fill" style="width: 0%"></div></div>
                    </div>
                    <div id="steps-container">
                        <!-- Step 0: OS Detection -->
                        <div id="step-0" class="step current"><div class="w-full max-w-lg mx-auto p-4 sm:p-6 flex flex-col flex-grow justify-center items-center text-center"><h1 class="text-4xl sm:text-5xl font-black mb-4 animated-item">¡Bienvenido!</h1><p class="text-base sm:text-lg text-gray-600 mb-6 animated-item" style="animation-delay: 100ms;">Este es el asistente de configuración de Eduroam.</p><div id="os-info" class="text-lg sm:text-xl font-bold p-4 bg-black/5 rounded-lg mb-8 animated-item" style="animation-delay: 200ms;"></div><p class="text-sm text-gray-500 mb-4 animated-item" style="animation-delay: 300ms;">Si no es correcto, selecciona tu sistema:</p><div class="flex gap-4 animated-item" style="animation-delay: 400ms;"><button onclick="startGuide('Android')" class="bg-black text-white font-bold py-2 px-6 rounded-full hover:bg-gray-800 transition">Android</button><button class="bg-black/5 text-gray-400 font-bold py-2 px-6 rounded-full cursor-not-allowed" disabled>iOS</button></div></div></div>
                        <!-- Step 1: Welcome -->
                        <div id="step-1" class="step future"><div class="w-full max-w-lg mx-auto p-4 sm:p-6 flex flex-col flex-grow justify-center"><h2 class="text-sm font-semibold uppercase text-gray-500 animated-item">Asistente Vitrum x UCuenca</h2><h1 class="text-5xl sm:text-7xl font-black my-2 leading-none animated-item" style="animation-delay: 100ms;">Conéctate a</h1><h1 class="text-5xl sm:text-7xl font-black text-purple-600 animated-item" style="animation-delay: 200ms;">Eduroam</h1><p class="text-base sm:text-lg text-gray-600 mt-6 animated-item" style="animation-delay: 300ms;">Esta guía te ayudará en el proceso de configuración para acceder a la red Wi-Fi de la Universidad de Cuenca.</p></div></div>
                        <!-- Other steps remain the same -->
                        <div id="step-2" class="step future"><div class="w-full max-w-lg mx-auto p-4 sm:p-6 flex flex-col flex-grow justify-center"><h1 class="text-4xl sm:text-5xl font-black mb-6 animated-item">¿Qué es Eduroam?</h1><p class="mb-8 text-gray-600 animated-item" style="animation-delay: 100ms;">Eduroam (Education Roaming) es un servicio mundial que ofrece acceso a internet seguro y universal en todas las instituciones afiliadas.</p><ul class="space-y-4 text-left"><li class="flex items-center animated-item" style="animation-delay: 200ms;"><svg class="w-6 h-6 mr-3 text-purple-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Acceso global en universidades aliadas.</li><li class="flex items-center animated-item" style="animation-delay: 300ms;"><svg class="w-6 h-6 mr-3 text-purple-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Conexión de alta velocidad y segura.</li><li class="flex items-center animated-item" style="animation-delay: 400ms;"><svg class="w-6 h-6 mr-3 text-purple-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Una vez configurado, te conectarás automáticamente.</li></ul></div></div>
                        <div id="step-3" class="step future"><div class="w-full max-w-lg mx-auto p-4 sm:p-6 flex flex-col flex-grow justify-center text-center"><div class="flex flex-col items-center gap-4 mb-6"><svg class="w-16 h-16 text-purple-600 animated-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><h1 class="text-4xl sm:text-5xl font-black animated-item" style="animation-delay: 100ms;">1. Prepárate</h1></div><p class="mb-4 text-gray-600 animated-item" style="animation-delay: 200ms;">Al final de la guía estará el enlace de instalación directa para tu dispositivo.</p><p class="mb-4 text-gray-600 animated-item" style="animation-delay: 300ms;">Se te guiará previamente cómo configurar la app eduroam y por ello es importante que prestes atención a todo el proceso de la guía.</p></div></div>
                        <div id="step-4" class="step future"><div class="w-full max-w-lg mx-auto p-4 sm:p-6 flex flex-col flex-grow justify-center text-center"><div class="flex flex-col items-center gap-4 mb-6"><svg class="w-16 h-16 text-purple-600 animated-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><h1 class="text-4xl sm:text-5xl font-black animated-item" style="animation-delay: 100ms;">2. Busca tu Institución</h1></div><p class="mb-6 text-gray-600 animated-item" style="animation-delay: 200ms;">Abre la app y en el campo de búsqueda, escribe y selecciona <span class="font-bold">"Universidad de Cuenca"</span>.</p><div class="bg-black/5 w-full h-48 rounded-xl flex items-center justify-center animated-item" style="animation-delay: 300ms;"><p class="text-gray-400">Aquí irá una imagen del paso</p></div></div></div>
                        <div id="step-5" class="step future"><div class="w-full max-w-lg mx-auto p-4 sm:p-6 flex flex-col flex-grow justify-center text-center"><div class="flex flex-col items-center gap-4 mb-6"><svg class="w-16 h-16 text-green-600 animated-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><h1 class="text-4xl sm:text-5xl font-black animated-item" style="animation-delay: 100ms;">3. Ingresa tus Datos</h1></div><p class="mb-6 text-gray-600 animated-item" style="animation-delay: 200ms;">Ingresa tu correo institucional y contraseña.</p><div class="space-y-4 text-left"><div class="bg-black/5 p-4 rounded-xl animated-item" style="animation-delay: 300ms;"><label class="text-sm text-gray-500">Correo Institucional</label><p class="font-mono text-gray-800 text-sm sm:text-base">tu.usuario@ucuenca.edu.ec</p></div><div class="bg-black/5 p-4 rounded-xl animated-item" style="animation-delay: 400ms;"><label class="text-sm text-gray-500">Contraseña</label><p class="font-mono text-gray-800">••••••••••</p></div></div></div></div>
                        <div id="step-6" class="step future"><div class="w-full max-w-lg mx-auto p-4 sm:p-6 flex flex-col flex-grow justify-center text-center"><h1 class="text-4xl sm:text-5xl font-black mb-6 animated-item">4. Guarda la Red</h1><p class="text-lg mb-6 text-gray-600 animated-item" style="animation-delay: 100ms;">¡Atención! Después de ingresar tus datos, aparecerá una ventana emergente. Presiona en <span class="font-bold">"Guardar"</span> o <span class="font-bold">"Conectar"</span>.</p><div class="bg-yellow-400/20 text-yellow-800 border-l-4 border-yellow-500 p-4 rounded-r-lg animated-item text-left" style="animation-delay: 200ms;"><p class="font-bold">Paso Crucial</p><p>No omitas esta ventana. Es necesaria para que tu dispositivo recuerde la red.</p></div></div></div>
                        <div id="step-7" class="step future"><div class="w-full max-w-lg mx-auto p-4 sm:p-6 flex flex-col flex-grow justify-center text-center"><h1 class="text-4xl sm:text-5xl font-black mb-6 animated-item">5. Permiso Final</h1><p class="text-lg mb-6 text-gray-600 animated-item" style="animation-delay: 100ms;">Sal de la aplicación. Es posible que el sistema te pida un último permiso. Debes presionar en <span class="font-bold">"Permitir"</span>.</p><div class="bg-black/5 w-full h-48 rounded-xl flex items-center justify-center animated-item" style="animation-delay: 200ms;"><p class="text-gray-400">Imagen de la ventana de permiso</p></div></div></div>
                        <div id="step-8" class="step future"><div class="w-full max-w-lg mx-auto p-4 sm:p-6 flex flex-col flex-grow justify-center items-center text-center"><div class="text-8xl mb-6 animated-item">🚀</div><h1 class="text-4xl sm:text-5xl font-black mb-4 animated-item" style="animation-delay: 100ms;">Inicia el Proceso</h1><p class="text-lg text-gray-600 mb-8 animated-item" style="animation-delay: 200ms;">Inicia el proceso de configuración como lo detallamos en esta guía. Si te pierdes, no te preocupes, siempre puedes regresar y volver a ver esta guía.</p><a href="https://play.google.com/store/apps/details?id=app.eduroam.geteduroam" target="_blank" class="block w-full text-center bg-blue-600 text-white font-bold py-4 px-6 rounded-full hover:bg-blue-700 transition text-lg animated-item" style="animation-delay: 300ms;">Instalar geteduroam</a><button onclick="restartGuide()" class="mt-4 text-gray-500 font-bold py-2 px-6 rounded-full hover:bg-black/5 transition animated-item" style="animation-delay: 400ms;">Reiniciar Guía</button></div></div>
                    </div>
                    <!-- Navigation -->
                    <div id="navigation" class="p-4 sm:p-6 mt-auto flex-shrink-0 flex justify-between items-center opacity-0" style="transition: opacity 0.5s;"><button id="back-btn" onclick="navigate(-1)" class="font-bold text-gray-500 py-3 px-4 hover:text-black transition">Atrás</button><button id="next-btn" onclick="navigate(1)" class="bg-black text-white font-bold py-4 px-10 rounded-full hover:bg-gray-800 transition">Siguiente</button></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        const steps = document.querySelectorAll('.step');
        const totalSteps = steps.length - 1; 
        const progressBar = document.getElementById('progress-bar');
        const navigation = document.getElementById('navigation');
        const nextBtn = document.getElementById('next-btn');

        function updateUI() {
            steps.forEach((step, index) => {
                step.classList.remove('current', 'past', 'future');
                if (index === currentStep) step.classList.add('current');
                else if (index < currentStep) step.classList.add('past');
                else step.classList.add('future');
            });
            const progress = currentStep > 0 ? ((currentStep - 1) / (totalSteps - 2)) * 100 : 0;
            progressBar.style.width = `${Math.min(progress, 100)}%`;
            navigation.style.opacity = (currentStep > 0 && currentStep < totalSteps) ? '1' : '0';
            navigation.style.pointerEvents = (currentStep > 0 && currentStep < totalSteps) ? 'auto' : 'none';
            document.getElementById('back-btn').style.visibility = (currentStep <= 1) ? 'hidden' : 'visible';
            nextBtn.textContent = (currentStep === totalSteps - 1) ? 'Finalizar' : 'Siguiente';
        }

        function navigate(direction) {
            const newStep = currentStep + direction;
            if (newStep >= 0 && newStep <= totalSteps) {
                currentStep = newStep;
                updateUI();
            }
        }
        
        function startGuide(os) {
            if (os === 'Android') {
                currentStep = 1;
                updateUI();
            } else {
                alert('Guía para ' + os + ' no está disponible aún.');
            }
        }

        function restartGuide() {
            currentStep = 0;
            updateUI();
        }

        // --- Detección de OS ---
        function getDetectedOS() {
            if (navigator.userAgent.match(/Android/i)) return "Android";
            if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) return "iOS";
            if (navigator.userAgent.match(/Windows/i)) return "Windows";
            if (navigator.userAgent.match(/Mac/i)) return "macOS";
            if (navigator.userAgent.match(/Linux/i)) return "Linux";
            return "Desconocido";
        }

        function getOSLogo(os) {
            switch (os) {
                case "Android": return `<img src="https://placehold.co/120x120/A4C639/FFFFFF?text=A" alt="Android Logo" class="w-full h-full object-contain rounded-3xl">`;
                case "iOS": return `<img src="https://placehold.co/120x120/333333/FFFFFF?text=i" alt="iOS Logo" class="w-full h-full object-contain rounded-3xl">`;
                case "Windows": return `<img src="https://placehold.co/120x120/00A4EF/FFFFFF?text=W" alt="Windows Logo" class="w-full h-full object-contain rounded-3xl">`;
                default: return `<img src="https://placehold.co/120x120/777777/FFFFFF?text=OS" alt="Generic OS Logo" class="w-full h-full object-contain rounded-3xl">`;
            }
        }
        
        // --- Flujo de Inicio Mejorado ---
        let fallbackTimeout = null;

        function transitionToShakeState() {
            const detectionState = document.getElementById('detection-state');
            const shakeState = document.getElementById('shake-state');
            const osLogoContainer = document.getElementById('os-logo-container');
            const splashScreen = document.getElementById('splash-screen');

            const os = getDetectedOS();
            osLogoContainer.innerHTML = getOSLogo(os);

            detectionState.style.opacity = '0';

            setTimeout(() => {
                detectionState.classList.add('hidden');
                shakeState.classList.remove('hidden');
                shakeState.style.display = 'flex'; // Ensure flex is applied
                splashScreen.classList.add('glass-active');
                setTimeout(() => {
                    shakeState.style.opacity = '1';
                    initShakeDetection();
                }, 50);
            }, 500);
        }

        function initParticleScanner() {
            const canvas = document.getElementById('particle-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particles = [];
            const numParticles = 150;
            let animationFrameId;
            let phase = 'exploding'; // 'exploding', 'imploding'

            class Particle {
                constructor() {
                    this.x = canvas.width / 2;
                    this.y = canvas.height / 2;
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 4 + 1;
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                    this.radius = Math.random() * 2 + 1;
                    this.color = `rgba(51, 51, 51, ${Math.random() * 0.5 + 0.2})`;
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                }

                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                }
            }

            function createParticles() {
                for (let i = 0; i < numParticles; i++) {
                    particles.push(new Particle());
                }
            }

            function animateParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let allParticlesImploded = true;

                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    
                    if (phase === 'exploding') {
                         p.update();
                    } else if (phase === 'imploding') {
                        const dx = canvas.width / 2 - p.x;
                        const dy = canvas.height / 2 - p.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        const speed = 5;

                        if (dist > speed) { // Check if distance is greater than speed
                            p.x += (dx / dist) * speed;
                            p.y += (dy / dist) * speed;
                            allParticlesImploded = false;
                        } else {
                            p.x = canvas.width/2;
                            p.y = canvas.height/2;
                        }
                    }
                    p.draw();
                }

                if (phase === 'imploding' && allParticlesImploded) {
                    cancelAnimationFrame(animationFrameId);
                    transitionToShakeState();
                    return;
                }
                animationFrameId = requestAnimationFrame(animateParticles);
            }

            createParticles();
            animateParticles();
            
            setTimeout(() => { phase = 'imploding'; }, 2500);
        }

        function startApp() {
            if (fallbackTimeout) clearTimeout(fallbackTimeout);
            initParallax();
            document.getElementById('splash-screen').style.opacity = '0';
            document.getElementById('splash-screen').style.pointerEvents = 'none';
            document.querySelector('.glass-pane').classList.add('visible');
            
            const os = getDetectedOS();
            document.getElementById('os-info').textContent = `Detectado: ${os}`;
            updateUI();
            if (os === "Android") {
                setTimeout(() => {
                    if (currentStep === 0) startGuide('Android');
                }, 1500);
            }
        }
        
        // --- Lógica para Agitar Dispositivo ---
        function initShakeDetection() {
            const SHAKE_THRESHOLD = 20;
            let motionListener = null;

            const handleMotionEvent = (event) => {
                const { x, y, z } = event.accelerationIncludingGravity;
                const acceleration = Math.sqrt(x*x + y*y + z*z);
                
                if (acceleration > SHAKE_THRESHOLD) {
                    if (navigator.vibrate) navigator.vibrate(100);
                    window.removeEventListener('devicemotion', motionListener);
                    startApp();
                }
            };

            motionListener = handleMotionEvent;

            // Set fallback timeout
            fallbackTimeout = setTimeout(() => {
                const fallbackBtn = document.getElementById('fallback-btn');
                fallbackBtn.classList.remove('hidden');
                setTimeout(() => fallbackBtn.style.opacity = '1', 50);
            }, 3000);

            document.getElementById('fallback-btn').addEventListener('click', () => {
                startApp();
            });

            // Permisos para iOS
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                const iosPermissionText = document.getElementById('ios-permission-text');
                iosPermissionText.classList.remove('hidden');
                
                const requestMotionPermission = () => {
                    DeviceMotionEvent.requestPermission().then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('devicemotion', motionListener);
                            iosPermissionText.textContent = "¡Sensor activado! Ahora agita el dispositivo.";
                        } else {
                            iosPermissionText.textContent = "Permiso denegado. No se puede usar la función de agitar.";
                        }
                    }).catch(console.error);
                    document.getElementById('splash-screen').removeEventListener('click', requestMotionPermission);
                };
                document.getElementById('splash-screen').addEventListener('click', requestMotionPermission);
            } else {
                window.addEventListener('devicemotion', motionListener);
            }
        }

        // --- Lógica de Parallax ---
        function initParallax() {
            const scene = document.getElementById('parallax-scene');
            const layers = scene.querySelectorAll('.layer');
            const sensitivity = 30;

            const handleMove = (x_ratio, y_ratio) => {
                layers.forEach(layer => {
                    const depth = layer.getAttribute('data-depth');
                    const x_axis = -x_ratio * sensitivity * depth;
                    const y_axis = -y_ratio * sensitivity * depth;
                    layer.style.transform = `translate3d(${x_axis}px, ${y_axis}px, 0)`;
                });
            }

            if (window.DeviceOrientationEvent && 'ontouchstart' in window) {
                window.addEventListener('deviceorientation', (event) => {
                    const beta = event.beta;
                    const gamma = event.gamma;
                    const y_ratio = Math.max(-1, Math.min(1, beta / 90));
                    const x_ratio = Math.max(-1, Math.min(1, gamma / 90));
                    handleMove(x_ratio, y_ratio);
                });
            } else {
                 window.addEventListener('mousemove', (event) => {
                    const x_ratio = (event.clientX / window.innerWidth) - 0.5;
                    const y_ratio = (event.clientY / window.innerHeight) - 0.5;
                    handleMove(x_ratio, y_ratio);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', initParticleScanner);
    </script>
</body>
</html>

