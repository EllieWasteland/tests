<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Cuenta | Vitrum Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        #loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #22d3ee;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="bg-gray-800 border border-gray-700 rounded-2xl p-8 max-w-2xl w-full shadow-lg">
        
        <!-- Vista de Carga Inicial -->
        <div id="loading-view" class="text-center">
            <div id="loader" class="mx-auto"></div>
            <p class="mt-4 text-gray-400">Iniciando...</p>
        </div>

        <!-- Vista de Login -->
        <div id="login-view" class="hidden text-center">
            <h1 class="text-3xl font-bold text-cyan-400">Configura tu Cuenta</h1>
            <p class="text-gray-400 mt-2 mb-8">Usa tu cuenta institucional de Google para empezar.</p>
            <button id="google-login-btn" class="inline-flex items-center justify-center gap-3 bg-white text-gray-800 font-semibold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.19,4.73C14.03,4.73 15.6,5.36 16.81,6.45L18.87,4.59C17.01,3.01 14.7,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.19,22C17.6,22 21.54,18.33 21.54,12.29C21.54,11.77 21.48,11.44 21.35,11.1Z"/></svg>
                <span>Iniciar Sesión con Google</span>
            </button>
        </div>

        <!-- Vista del Formulario de Configuración -->
        <div id="form-view" class="hidden">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-cyan-400">Completa tu Perfil</h1>
                <p class="text-gray-400 mt-2">Personaliza tu experiencia en la aplicación.</p>
            </div>

            <form id="data-generator-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-300 mb-1">Nombres</label>
                        <input type="text" id="firstName" class="w-full bg-gray-700 border-gray-600 rounded-lg px-4 py-2 focus:ring-cyan-500 focus:border-cyan-500" required>
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-300 mb-1">Apellidos</label>
                        <input type="text" id="lastName" class="w-full bg-gray-700 border-gray-600 rounded-lg px-4 py-2 focus:ring-cyan-500 focus:border-cyan-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Institucional</label>
                        <input type="email" id="email" class="w-full bg-gray-600 border-gray-500 rounded-lg px-4 py-2 cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label for="nickname" class="block text-sm font-medium text-gray-300 mb-1">Apodo (Opcional)</label>
                        <input type="text" id="nickname" class="w-full bg-gray-700 border-gray-600 rounded-lg px-4 py-2 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="major" class="block text-sm font-medium text-gray-300 mb-1">Carrera</label>
                        <select id="major" class="w-full bg-gray-700 border-gray-600 rounded-lg px-4 py-2 focus:ring-cyan-500 focus:border-cyan-500">
                            <option value="periodismo">Periodismo</option>
                            <option value="educacion-basica" selected>E. Básica</option>
                            <option value="educacion-inicial">E. Inicial</option>
                            <option value="filosofia">Filosofía</option>
                        </select>
                    </div>
                    <div>
                        <label for="cycle" class="block text-sm font-medium text-gray-300 mb-1">Ciclo</label>
                        <select id="cycle" class="w-full bg-gray-700 border-gray-600 rounded-lg px-4 py-2 focus:ring-cyan-500 focus:border-cyan-500">
                            <option value="1" selected>Ciclo 1</option>
                            <option value="2">Ciclo 2</option>
                            <option value="3">Ciclo 3</option>
                            <option value="4">Ciclo 4</option>
                            <option value="5">Ciclo 5</option>
                            <option value="6">Ciclo 6</option>
                            <option value="7">Ciclo 7</option>
                            <option value="8">Ciclo 8</option>
                        </select>
                    </div>
                    <div>
                        <label for="modality" class="block text-sm font-medium text-gray-300 mb-1">Modalidad</label>
                        <select id="modality" class="w-full bg-gray-700 border-gray-600 rounded-lg px-4 py-2 focus:ring-cyan-500 focus:border-cyan-500">
                            <option value="matutino" selected>Matutina</option>
                            <option value="vespertino">Vespertina</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-2 gap-6 mt-4">
                        <div class="flex items-center p-4 border border-gray-600 rounded-lg">
                            <input id="isContinuous" type="checkbox" checked class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-cyan-600 focus:ring-cyan-500">
                            <label for="isContinuous" class="ml-3 block text-sm font-medium text-gray-300">¿Estudiante continuo?</label>
                        </div>
                        <div class="flex items-center p-4 border border-gray-600 rounded-lg">
                            <input id="useAI" type="checkbox" checked class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-cyan-600 focus:ring-cyan-500">
                            <label for="useAI" class="ml-3 block text-sm font-medium text-gray-300">¿Autocompletar horario?</label>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-cyan-500">
                        Finalizar Configuración y Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB1W2yLlVHivzBQPZJVOgpApQeYnJUFzCs",
            authDomain: "vitreumucuencahub.firebaseapp.com",
            projectId: "vitreumucuencahub",
            storageBucket: "vitreumucuencahub.firebasestorage.app",
            messagingSenderId: "628136581064",
            appId: "1:6281365-4602fd2fd"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const formView = document.getElementById('form-view');
        const loginBtn = document.getElementById('google-login-btn');
        const form = document.getElementById('data-generator-form');

        // Manejo del estado de autenticación
        auth.onAuthStateChanged(user => {
            loadingView.classList.add('hidden');
            if (user) {
                // Si el usuario está autenticado, muestra el formulario
                if (!user.email.endsWith('@ucuenca.edu.ec')) {
                    alert('Acceso denegado. Debes usar una cuenta de correo institucional (@ucuenca.edu.ec).');
                    auth.signOut();
                    return;
                }
                populateForm(user);
                loginView.classList.add('hidden');
                formView.classList.remove('hidden');
            } else {
                // Si no, muestra la pantalla de login
                formView.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
        });

        // Evento para el botón de login
        loginBtn.addEventListener('click', () => {
            auth.signInWithPopup(provider).catch(error => {
                console.error("Error de autenticación:", error);
                alert("Error al iniciar sesión: " + error.message);
            });
        });

        // Rellenar formulario con datos del usuario
        function populateForm(user) {
            document.getElementById('email').value = user.email;
            const nameParts = user.displayName.split(' ');
            const lastName = nameParts.pop() || '';
            const firstName = nameParts.join(' ');
            document.getElementById('firstName').value = firstName;
            document.getElementById('lastName').value = lastName;
        }

        // Evento para enviar el formulario
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                alert("No estás autenticado. Por favor, inicia sesión de nuevo.");
                return;
            }

            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;

            const userData = {
                uid: user.uid, // UID real de Firebase
                email: user.email,
                firstName: firstName,
                lastName: lastName,
                displayName: `${firstName} ${lastName}`,
                nickname: document.getElementById('nickname').value,
                photoURL: user.photoURL,
                isContinuous: document.getElementById('isContinuous').checked,
                major: document.getElementById('major').value,
                cycle: document.getElementById('cycle').value,
                modality: document.getElementById('modality').value,
                useAI: document.getElementById('useAI').checked
            };

            const jsonString = JSON.stringify(userData);
            const base64String = btoa(jsonString);
            
            // URL de la app principal
            const targetUrl = `http://127.0.0.1:5500/index.html?userData=${encodeURIComponent(base64String)}`;
            
            console.log("Redirigiendo a:", targetUrl);
            console.log("Datos enviados (decodificados):", userData);
            
            window.location.href = targetUrl;
        });
    </script>
</body>
</html>

