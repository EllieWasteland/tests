<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Tickets | Vitrum Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs (versión modular v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyB1W2yLlVHivzBQPZJVOgpApQeYnJUFzCs",
            authDomain: "vitreumucuencahub.firebaseapp.com",
            projectId: "vitreumucuencahub",
            storageBucket: "vitreumucuencahub.firebasestorage.app",
            messagingSenderId: "628136581064",
            appId: "1:6281365-4602fd2fd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginBtn = document.getElementById('google-login-btn');
        const formSteps = document.querySelectorAll('.form-step');
        const nextButtons = document.querySelectorAll('.next-btn');
        const backButtons = document.querySelectorAll('.back-btn');
        const submitButton = document.getElementById('submit-btn');

        let currentStep = 0;
        let userData = {};

        onAuthStateChanged(auth, user => {
            loadingView.classList.add('hidden');
            if (user) {
                if (!user.email.endsWith('@ucuenca.edu.ec')) {
                    showModal('Acceso denegado', 'Debes usar una cuenta de correo institucional (@ucuenca.edu.ec).');
                    signOut(auth);
                    return;
                }
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
                initializeForm(user);
            } else {
                appView.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
        });

        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => {
                console.error("Error de autenticación:", error);
                showModal("Error de autenticación", error.message);
            });
        });

        function showStep(stepIndex) {
            formSteps.forEach((step, index) => {
                step.classList.toggle('hidden', index !== stepIndex);
            });
        }
        
        nextButtons.forEach(button => {
            button.addEventListener('click', () => {
                const currentInputs = formSteps[currentStep].querySelectorAll('input[required], select[required]');
                let isValid = true;
                currentInputs.forEach(input => {
                    if (!input.value) {
                        input.classList.add('border-red-500');
                        isValid = false;
                    } else {
                        input.classList.remove('border-red-500');
                    }
                });

                if (isValid && currentStep < formSteps.length - 1) {
                    currentStep++;
                    showStep(currentStep);
                } else if (!isValid) {
                     showModal('Campos requeridos', 'Por favor, completa todos los campos obligatorios para continuar.');
                }
            });
        });

        backButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    showStep(currentStep);
                }
            });
        });

        function initializeForm(user) {
            const nameParts = user.displayName.split(' ');
            const lastName = nameParts.pop() || '';
            const firstName = nameParts.join(' ');

            document.getElementById('firstName').value = firstName;
            document.getElementById('lastName').value = lastName;
            document.getElementById('email').value = user.email;

            userData = {
                uid: user.uid,
                email: user.email,
                photoURL: user.photoURL,
                zone: String(Math.floor(Math.random() * 99) + 1).padStart(2, '0'),
                row: String(Math.floor(Math.random() * 20) + 1).padStart(2, '0'),
                seat: String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0'),
                ticketNumber: `no.${Math.floor(Math.random() * 9000000) + 1000000}`,
            };

            updateTicketPreview();
            generateBarcode();
            showStep(0);
            attachInputListeners();
        }

        function updateTicketPreview() {
            userData.firstName = document.getElementById('firstName').value;
            userData.lastName = document.getElementById('lastName').value;
            userData.nickname = document.getElementById('nickname').value;
            userData.major = document.getElementById('major').value;
            userData.cycle = document.getElementById('cycle').value;
            userData.modality = document.getElementById('modality').value;
            
            document.getElementById('ticket-username').textContent = userData.nickname || `${userData.firstName.split(' ')[0]} ${userData.lastName.split(' ')[0]}`;
            document.getElementById('ticket-photo').src = userData.photoURL || `https://ui-avatars.com/api/?name=${userData.firstName}+${userData.lastName}&background=EAB308&color=fff`;
            document.getElementById('ticket-zone').textContent = userData.zone;
            document.getElementById('ticket-row').textContent = userData.row;
            document.getElementById('ticket-seat').textContent = userData.seat;
            document.getElementById('ticket-number').textContent = userData.ticketNumber;
        }

        function generateBarcode() {
            const barcodeContainer = document.getElementById('ticket-barcode');
            barcodeContainer.innerHTML = '';
            for (let i = 0; i < 60; i++) {
                const bar = document.createElement('div');
                bar.style.width = (Math.random() > 0.5 ? '2px' : '1.5px');
                bar.style.height = '100%';
                bar.style.backgroundColor = '#44403c';
                barcodeContainer.appendChild(bar);
            }
        }
        
        function attachInputListeners() {
            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('input', updateTicketPreview);
            });
        }
        
        submitButton.addEventListener('click', () => {
            updateTicketPreview();
            
            const finalUserData = {
                 ...userData,
                 displayName: `${userData.firstName} ${userData.lastName}`,
                 isContinuous: document.getElementById('isContinuous').checked,
                 useAI: document.getElementById('useAI').checked
            };

            const jsonString = JSON.stringify(finalUserData);
            const base64String = btoa(jsonString);
            const targetUrl = `http://127.0.0.1:5500/index.html?userData=${encodeURIComponent(base64String)}`;
            
            showModal('¡Configuración Completa!', `Serás redirigido a la aplicación principal.`, () => {
                 window.location.href = targetUrl;
            });
        });

        function showModal(title, message, onConfirm) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirm = document.getElementById('modal-confirm-btn');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            const newConfirmBtn = modalConfirm.cloneNode(true);
            modalConfirm.parentNode.replaceChild(newConfirmBtn, modalConfirm);

            const closeAction = () => {
                modal.classList.add('hidden');
                if (onConfirm) onConfirm();
            };

            newConfirmBtn.addEventListener('click', closeAction);
            modal.classList.remove('hidden');
        }
    </script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F3EADF;
        }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .font-display { font-family: 'Poppins', sans-serif; }
        .hard-shadow { box-shadow: 8px 8px 0px #000; }
        .input-field {
            background-color: #FFF;
            border: 3px solid #000;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .input-field:focus {
            box-shadow: 4px 4px 0px #000;
            transform: translate(-2px, -2px);
        }
        .btn-primary {
            background-color: #F59E0B; /* amber-500 */
            border: 3px solid #000;
            font-weight: 700;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 4px 4px 0px #000;
            transform: translate(-4px, -4px);
        }
        .btn-secondary {
            background-color: #D6D3D1; /* stone-300 */
            border: 3px solid #000;
            font-weight: 700;
            border-radius: 0.5rem;
             transition: all 0.2s;
        }
        .btn-secondary:hover {
            box-shadow: 4px 4px 0px #000;
            transform: translate(-4px, -4px);
        }
        /* Memphis BG Shapes */
        .memphis-bg {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden;
            z-index: -1;
        }
    </style>
</head>
<body class="text-stone-800">

    <!-- Memphis Background -->
    <div class="memphis-bg">
        <svg width="100" height="100" class="absolute top-1/4 left-1/4 opacity-30 text-orange-400 -translate-x-1/2 -translate-y-1/2"><circle cx="50" cy="50" r="50" fill="currentColor"/></svg>
        <svg width="80" height="80" class="absolute bottom-10 right-10 opacity-40 text-red-500"><path d="M 0 80 L 40 0 L 80 80 Z" fill="currentColor" /></svg>
        <svg width="120" height="120" class="absolute top-10 left-20 opacity-50 text-amber-400" viewBox="0 0 100 100"><path d="M 10 10 C 20 80, 80 20, 90 90" stroke="currentColor" stroke-width="8" fill="none" /></svg>
    </div>

    <!-- Loader -->
    <div id="loading-view" class="fixed inset-0 flex flex-col items-center justify-center bg-[#F3EADF] z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-stone-800"></div>
        <p class="mt-4 text-lg font-semibold">Cargando...</p>
    </div>

    <!-- Login -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center p-4">
         <div class="text-center bg-white p-10 border-4 border-black hard-shadow max-w-md w-full">
             <h1 class="text-4xl font-black mb-2">Generador de Tickets</h1>
             <p class="text-stone-600 mb-8">Usa tu cuenta institucional para crear tu pase de acceso.</p>
             <button id="google-login-btn" class="btn-primary inline-flex items-center justify-center gap-3 py-3 px-6 text-lg w-full">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.19,4.73C14.03,4.73 15.6,5.36 16.81,6.45L18.87,4.59C17.01,3.01 14.7,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.19,22C17.6,22 21.54,18.33 21.54,12.29C21.54,11.77 21.48,11.44 21.35,11.1Z"/></svg>
                 <span>Iniciar Sesión con Google</span>
             </button>
         </div>
    </div>

    <!-- App principal -->
    <main id="app-view" class="hidden w-full max-w-5xl mx-auto flex flex-col items-center p-4 md:p-8 space-y-8">
        
        <!-- Ticket Preview -->
        <div class="w-full max-w-2xl">
            <div class="bg-stone-50 p-1 border-4 border-black rounded-2xl hard-shadow">
                <div class="flex h-64">
                    <!-- Parte izquierda del ticket -->
                    <div class="w-[65%] p-4 flex flex-col justify-between rounded-l-xl bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1594903335019-35c483c7a845?q=80&w=1932&auto=format&fit=crop');">
                       <div class="flex justify-between items-start">
                           <div>
                               <p class="font-bold text-white bg-black/50 px-2 py-1 rounded text-sm">VITRUM</p>
                               <p class="font-bold text-white bg-black/50 px-2 py-1 rounded text-sm mt-1">SPACE</p>
                           </div>
                           <p class="font-bold text-black bg-amber-400 px-2 py-1 rounded text-sm transform -rotate-12">VIP</p>
                       </div>
                       <div class="text-white">
                           <h3 class="text-3xl font-black tracking-tighter leading-none">THE VIRTUAL</h3>
                           <p class="text-xs font-semibold">22-24 & 29-31 JULY 2025 IN VITRUM SPACE</p>
                       </div>
                    </div>
                    <!-- Línea punteada -->
                    <div class="w-px bg-repeat-y bg-center relative" style="background-image: linear-gradient(to bottom, #44403c 60%, transparent 40%); background-size: 1px 10px;">
                        <div class="absolute -left-2 top-0 bg-[#F3EADF] w-4 h-4 rounded-full border-4 border-stone-50"></div>
                        <div class="absolute -left-2 bottom-0 bg-[#F3EADF] w-4 h-4 rounded-full border-4 border-stone-50"></div>
                    </div>
                    <!-- Parte derecha del ticket -->
                    <div class="w-[35%] bg-stone-50 text-stone-800 flex flex-col justify-between items-center p-2 rounded-r-xl">
                        <div class="text-center w-full">
                           <img id="ticket-photo" src="" alt="User Photo" class="rounded-full w-12 h-12 mx-auto mb-1 border-2 border-stone-300">
                           <div class="grid grid-cols-3 text-[10px] font-bold text-stone-500 px-1">
                               <span>Zone</span><span>Row</span><span>Seat Number</span>
                           </div>
                           <div class="grid grid-cols-3 text-lg font-mono font-bold text-stone-900 leading-tight">
                               <span id="ticket-zone">00</span><span id="ticket-row">00</span><span id="ticket-seat">0000</span>
                           </div>
                           <p id="ticket-number" class="text-xs text-stone-500 font-mono mt-1">no.0000000</p>
                        </div>
                        <div class="text-center w-full">
                            <p id="ticket-username" class="font-bold text-xl leading-tight">Username</p>
                        </div>
                        <div id="ticket-barcode" class="h-10 w-full flex items-end justify-center gap-[1px]"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Section -->
        <div class="w-full max-w-2xl bg-white p-8 border-4 border-black hard-shadow">
            <!-- Paso 1: Datos Personales -->
            <div id="step-1" class="form-step">
                <h2 class="text-2xl font-black mb-1">Paso 1: Datos Personales</h2>
                <p class="text-stone-600 mb-6">Confirma tu nombre y elige un apodo.</p>
                <div class="space-y-4">
                    <input type="text" id="firstName" class="input-field w-full p-3" placeholder="Nombres" required>
                    <input type="text" id="lastName" class="input-field w-full p-3" placeholder="Apellidos" required>
                    <input type="text" id="nickname" class="input-field w-full p-3" placeholder="Apodo para el ticket (Opcional)">
                    <input type="email" id="email" class="input-field w-full p-3 bg-stone-200 cursor-not-allowed" readonly>
                </div>
                <div class="mt-8 text-right">
                    <button class="next-btn btn-primary py-2 px-8">Siguiente</button>
                </div>
            </div>
            <!-- Paso 2: Datos Académicos -->
            <div id="step-2" class="form-step hidden">
                <h2 class="text-2xl font-black mb-1">Paso 2: Info Académica</h2>
                <p class="text-stone-600 mb-6">Selecciona los detalles de tu carrera.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <select id="major" class="input-field w-full p-3"><option value="periodismo">Periodismo</option><option value="educacion-basica" selected>E. Básica</option></select>
                    <select id="cycle" class="input-field w-full p-3"><option value="1" selected>Ciclo 1</option><option value="2">Ciclo 2</option></select>
                    <div class="md:col-span-2">
                        <select id="modality" class="input-field w-full p-3"><option value="matutino" selected>Matutina</option><option value="vespertino">Vespertina</option></select>
                    </div>
                </div>
                <div class="mt-8 flex justify-between">
                    <button class="back-btn btn-secondary py-2 px-8">Atrás</button>
                    <button class="next-btn btn-primary py-2 px-8">Siguiente</button>
                </div>
            </div>
             <!-- Paso 3: Confirmación -->
            <div id="step-3" class="form-step hidden text-center">
                <h2 class="text-3xl font-black mb-1">¡Casi listo!</h2>
                <p class="text-stone-600 mb-6">Revisa tu ticket. Si todo está correcto, finaliza la configuración.</p>
                 <div class="md:col-span-2 mt-4 space-y-3 text-left">
                    <div class="flex items-center p-3 input-field">
                        <input id="isContinuous" type="checkbox" checked class="h-5 w-5 rounded-sm border-2 border-stone-800 text-amber-500 focus:ring-amber-400">
                        <label for="isContinuous" class="ml-3 block font-semibold text-stone-800">¿Estudiante continuo?</label>
                    </div>
                    <div class="flex items-center p-3 input-field">
                        <input id="useAI" type="checkbox" checked class="h-5 w-5 rounded-sm border-2 border-stone-800 text-amber-500 focus:ring-amber-400">
                        <label for="useAI" class="ml-3 block font-semibold text-stone-800">¿Autocompletar horario con IA?</label>
                    </div>
                </div>
                <div class="mt-8 flex flex-col items-center gap-4">
                    <button id="submit-btn" class="w-full btn-primary py-3 text-lg bg-green-500">Finalizar y Enviar Ticket</button>
                    <button class="back-btn btn-secondary py-2 px-8">Atrás</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 border-4 border-black hard-shadow max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-2xl font-black text-stone-800 mb-2"></h3>
            <p id="modal-message" class="text-stone-600 mb-6"></p>
            <button id="modal-confirm-btn" class="btn-primary py-2 px-8">Entendido</button>
        </div>
    </div>
</body>
</html>

